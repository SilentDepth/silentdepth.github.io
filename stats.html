<!doctype html>
<meta charset="utf-8">
<title>Daily Stats Report?</title>
<style>
  .top10 {
    margin: 10px;
    padding: 20px;
    border: 1px solid #999;
    border-radius: 4px;
    float: left;
  }
  ol {
    margin-bottom: 0;
  }
  li span {
    margin-left: 1em;
    color: #999;
    float: right;
  }
</style>
<script src="https://unpkg.com/es5-shim/es5-shim.min.js"></script>
<script src="https://unpkg.com/promise-polyfill/promise.min.js"></script>
<script src="https://unpkg.com/whatwg-fetch/fetch.js"></script>
<script src="https://unpkg.com/dot/doT.min.js"></script>

<div id="target"></div>

<script type="text/template" id="tmpl">
  <p><strong>数据新鲜度：</strong>{{=it.freshness}}</p>
  <p><strong>欢迎萌新：</strong>{{=it.newbies.join('、')}}</p>
  <div class="top10">
    <strong>在线时长 TOP 10</strong>
    <ol>
      {{~it.timeLived.reverse() :p}}
      <li>{{=p[0]}}<span>{{=Math.round(p[1] / 3600 * 10) / 10}} 小时</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>死亡次数 TOP 10</strong>
    <ol>
      {{~it['stat.deaths'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 次</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>被苦力怕炸飞 TOP 10</strong>
    <ol>
      {{~it['stat.entityKilledBy.Creeper'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 次</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>奔跑距离 TOP 10</strong>
    <ol>
      {{~it['stat.sprintOneCm'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=Math.round(p[1] / 100)}} 米</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>鞘翅飞行距离 TOP 10</strong>
    <ol>
      {{~it.aviate.reverse() :p}}
      <li>{{=p[0]}}<span>{{=Math.round(p[1] / 100)}} 米</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>乘坐矿车移动距离 TOP 10</strong>
    <ol>
      {{~it['stat.minecartOneCm'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=Math.round(p[1] / 100)}} 米</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>骑马移动距离 TOP 10</strong>
    <ol>
      {{~it['stat.horseOneCm'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=Math.round(p[1] / 100)}} 米</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>消灭蛋糕 TOP 10</strong>
    <ol>
      {{~it.cakeEaten.reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 片</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>开采下界石英矿石 TOP 10</strong>
    <ol>
      {{~it['stat.mineBlock.minecraft.quartz_ore'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 块</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>开采钻石矿石 TOP 10</strong>
    <ol>
      {{~it['stat.mineBlock.minecraft.diamond_ore'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 块</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>开采铁矿石 TOP 10</strong>
    <ol>
      {{~it['stat.mineBlock.minecraft.iron_ore'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 块</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>村民交易 TOP 10</strong>
    <ol>
      {{~it['stat.tradedWithVillager'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 次</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>怪物击杀 TOP 10</strong>
    <ol>
      {{~it['stat.mobKills'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 只</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>玩家击杀 TOP 10</strong>
    <ol>
      {{~it['stat.playerKills'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 人</span></li>
      {{~}}
    </ol>
  </div>
  <div class="top10">
    <strong>觉不能停 TOP 10</strong>
    <ol>
      {{~it['stat.sleepInBed'].reverse() :p}}
      <li>{{=p[0]}}<span>{{=p[1]}} 次</span></li>
      {{~}}
    </ol>
  </div>
</script>

<script>
  var json;

  fetch('./stats.json')
    .then(function (res) {return res.json();})
    .then(function (j) {
      json = j;
      console.log('Stats data has been loaded. You can now play around with `json`.');
    })
    .then(function () {
      var stats = {
        freshness: new Date(json.update).toLocaleString(),
        newbies: [],
        aviate: [['', 0]],
        timeLived: [['', 0]],
        cakeEaten: [['', 0]],
        'stat.deaths': [['', 0]],
        'stat.mineBlock.minecraft.quartz_ore': [['', 0]],
        'stat.playerKills': [['', 0]],
        'stat.mineBlock.minecraft.diamond_ore': [['', 0]],
        'stat.minecartOneCm': [['', 0]],
        'stat.sprintOneCm': [['', 0]],
        'stat.mineBlock.minecraft.iron_ore': [['', 0]],
        'stat.entityKilledBy.Creeper': [['', 0]],
        'stat.mobKills': [['', 0]],
        'stat.tradedWithVillager': [['', 0]],
        'stat.sleepInBed': [['', 0]],
        'stat.horseOneCm': [['', 0]],
      };
      json.players.forEach(function (player) {
        if (player.data.banned) return;
        var name = player.data.playername;
        var key;
        if (player.data.time_start > (json.update - 86400000)) stats.newbies.push(name);
        if (player.stats['stat.aviateOneCm'] > stats.aviate[0][1]) {
          stats.aviate.push([name, player.stats['stat.aviateOneCm']]);
          stats.aviate = stats.aviate.sort((a, b) => a[1] - b[1]).slice(-10);
        }
        if (player.data.time_lived > stats.timeLived[0][1]) {
          stats.timeLived.push([name, player.data.time_lived]);
          stats.timeLived = stats.timeLived.sort((a, b) => a[1] - b[1]).slice(-10);
        }
        if (player.stats['stat.cakeSlicesEaten'] > stats.cakeEaten[0][1]) {
          stats.cakeEaten.push([name, player.stats['stat.cakeSlicesEaten']]);
          stats.cakeEaten = stats.cakeEaten.sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.deaths';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.mineBlock.minecraft.quartz_ore';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.playerKills';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.mineBlock.minecraft.diamond_ore';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.minecartOneCm';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.sprintOneCm';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.mineBlock.minecraft.iron_ore';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.entityKilledBy.Creeper';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.mobKills';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.tradedWithVillager';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.sleepInBed';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
        key = 'stat.horseOneCm';
        if (player.stats[key] > stats[key][0][1]) {
          stats[key].push([name, player.stats[key]]);
          stats[key] = stats[key].sort((a, b) => a[1] - b[1]).slice(-10);
        }
      });
      var tmpl = doT.template(document.getElementById('tmpl').innerText);
      document.getElementById('target').innerHTML = tmpl(stats);
    });
</script>